#include "hardware/i2c.h"
#include "pico/cyw43_arch.h"
#include "pico/stdlib.h"

#define SSD1306_I2C_ADDR 0x3C
#define I2C_SDA 4
#define I2C_SCL 5

#define SSD1306_WIDTH 128
#define SSD1306_HEIGHT 64

#define SSD1306_SET_CONTRAST 0x81
#define SSD1306_DISPLAY_ALL_ON_RESUME 0xA4
#define SSD1306_DISPLAY_ALL_ON 0xA5
#define SSD1306_NORMAL_DISPLAY 0xA6
#define SSD1306_INVERT_DISPLAY 0xA7
#define SSD1306_DISPLAY_OFF 0xAE
#define SSD1306_DISPLAY_ON 0xAF

#define SSD1306_RIGHT_HORIZONTAL_SCROLL 0x26
#define SSD1306_LEFT_HORIZONTAL_SCROLL 0x27
#define SSD1306_VERTICAL_RIGHT_SCROLL 0x29
#define SSD1306_VERTICAL_LEFT_SCROLL 0x2A
#define SSD1306_DEACTIVATE_SCROLL 0x2E
#define SSD1306_ACTIVATE_SCROLL 0x2F
#define SSD1306_SET_VERTICAL_SCROLL_AREA 0xA3

#define SSD1306_SET_LOWER_COLUMN 0x00
#define SSD1306_SET_HIGHER_COLUMN 0x10
#define SSD1306_MEMORY_MODE 0x20
#define SSD1306_MEM_MODE_HORIZONTAL 0x00
#define SSD1306_MEM_MODE_VERTICAL 0x01
#define SSD1306_MEM_MODE_PAGE 0x02
#define SSD1306_SET_COLUMN_ADDR 0x21
#define SSD1306_SET_PAGE_ADDR 0x22
#define SSD1306_SET_PAGE_START_ADDR 0xB0

#define SSD1306_SET_START_LINE 0x40
#define SSD1306_SET_SEGMENT_REMAP_0 0xA0
#define SSD1306_SET_SEGMENT_REMAP_127 0xA1
#define SSD1306_SET_MULTIPLEX_RATIO 0xA8
#define SSD1306_COM_SCAN_INC 0xC0
#define SSD1306_COM_SCAN_DEC 0xC8
#define SSD1306_SET_DISPLAY_OFFSET 0xD3
#define SSD1306_SET_COM_PINS 0xDA

#define SSD1306_SET_DISPLAY_CLOCK_DIV 0xD5
#define SSD1306_SET_PRECHARGE_PERIOD 0xD9
#define SSD1306_SET_VCOM_DESELECT 0xDB
#define SSD1306_NOP 0xE3

#define SSD1306_CHARGE_PUMP 0x8D
#define SSD1306_CHARGE_PUMP_DISABLE 0x10
#define SSD1306_CHARGE_PUMP_ENABLE 0x14

#define SSD1306_CONTROL_CMD_SINGLE 0x80
#define SSD1306_CONTROL_CMD_STREAM 0x00
#define SSD1306_CONTROL_DATA_STREAM 0x40

#define SSD1306_MULTIPLEX_64 0x3F
#define SSD1306_COM_PINS_64 0x12
#define SSD1306_MULTIPLEX_32 0x1F
#define SSD1306_COM_PINS_32 0x02

void ssd1306_send_command(uint8_t cmd) {
  uint8_t buf[2] = {SSD1306_CONTROL_CMD_SINGLE, cmd};
  i2c_write_blocking(i2c_default, SSD1306_I2C_ADDR, buf, 2, false);
}

void ssd1306_init() {
  sleep_ms(100);
  ssd1306_send_command(SSD1306_DISPLAY_OFF);
  ssd1306_send_command(SSD1306_MEMORY_MODE);
  ssd1306_send_command(SSD1306_MEM_MODE_HORIZONTAL);
  ssd1306_send_command(SSD1306_SET_MULTIPLEX_RATIO);
  ssd1306_send_command(SSD1306_MULTIPLEX_64);
  ssd1306_send_command(SSD1306_SET_COM_PINS);
  ssd1306_send_command(SSD1306_COM_PINS_64);
  ssd1306_send_command(SSD1306_CHARGE_PUMP);
  ssd1306_send_command(SSD1306_CHARGE_PUMP_ENABLE);
  ssd1306_send_command(SSD1306_DISPLAY_ON);
}

int main() {
  if (cyw43_arch_init())
    return -1;

  i2c_init(i2c_default, 400000);
  gpio_set_function(I2C_SDA, GPIO_FUNC_I2C);
  gpio_set_function(I2C_SCL, GPIO_FUNC_I2C);
  gpio_pull_up(I2C_SDA);
  gpio_pull_up(I2C_SCL);

  ssd1306_init();

  for (;;) {
    cyw43_arch_gpio_put(CYW43_WL_GPIO_LED_PIN, 1);
    sleep_ms(250);
    cyw43_arch_gpio_put(CYW43_WL_GPIO_LED_PIN, 0);
    sleep_ms(250);
  }
}
